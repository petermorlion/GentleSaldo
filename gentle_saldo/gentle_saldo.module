<?php

/**
* @file
* A custom module for Gentle Ultimate Frisbee and how much the members have to pay.
*/

/**
* Implements hook_help.
*
* Displays help and module information.
*
* @param path
*   Which path of the site we're using to display help
* @param arg
*   Array that holds the current path as returned from arg() function
*/
function gentle_saldo_help($path, $arg) {
  switch ($path) {
    case "admin/help#gentle_saldo":
      return '<p>' . t("A custom module for Gentle Ultimate Frisbee and how much the members have to pay.") . '</p>';
      break;
  }
}

/**
* Implementation of hook_menu
*/
function gentle_saldo_menu() {
    $items['user/%user/saldo'] = array(
        'title' => t('Saldo'),
        'page callback' => 'gentle_saldo_user_saldo',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_LOCAL_TASK,
        ); 

    $items['admin/gentle_saldo'] = array(
        'title' => 'Saldos',
        'description' => 'Overview of the Gentle saldos.',
        'page callback' => 'gentle_saldo_overview',
        'page arguments' => array(1),
        'access arguments' => array('access gentle_saldo'),
        'type' => MENU_NORMAL_ITEM,
    );
    
    $items['admin/gentle_saldo/overview'] = array(
        'title' => 'Overzicht',
        'description' => 'Overview of the Gentle saldos.',
        'page callback' => 'gentle_saldo_overview',
        'page arguments' => array(1),
        'access arguments' => array('access gentle_saldo'),
        'type' => MENU_DEFAULT_LOCAL_TASK,
    );

    $items['admin/gentle_saldo/update'] = array(
        'title' => 'Upload',
        'description' => 'Upload the saldos.',
        'page callback' => 'gentle_saldo_update',
        'page arguments' => array(1),
        'access arguments' => array('access gentle_saldo'),
        'type' => MENU_LOCAL_TASK,
    );

    $items['admin/gentle_saldo/settings'] = array(
        'title' => 'Settings',
        'description' => 'Configuration for the Gentle saldo system.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('gentle_saldo_settings'),
        'access arguments' => array('access gentle_saldo'),
        'type' => MENU_LOCAL_TASK,
    );

    return $items;
}

/**
* Valid permissions for this module
* @return array An array of valid permissions for the gentle_saldo module
*/
function gentle_saldo_perm() {
    return array('access gentle_saldo', 'debug gentle_saldo');
}

/**
 * Implementation of hook_permission. Provides the permissions so they can be selected on the Permissions page.
 */
function gentle_saldo_permission() {
    return array(
        'access gentle_saldo' => array(
            'title' => t('Manage Gentle saldos.'),
            'description' => t('Manage the saldos of Gentle members, send mails, change settings.')
        ),
        'debug gentle_saldo' => array(
            'title' => t('Debug Gentle saldos.'),
            'description' => t('Debugging Gentle saldos.')
        ) 
    );
}

/**
* Show the saldo of the current user (needs improvements like using the Drupal DB API,...)
*/
function gentle_saldo_user_saldo() {
    return gentle_saldo_user_saldo_html($GLOBALS['user']->uid);
}

/**
 * Returns the HTML for the user saldo.
 */
function gentle_saldo_user_saldo_html($uid) {
    $row = "";	
    $query = "select max(id) as id from gentle_saldo_update";
    $rs = db_query($query);

    # iterate over resultset, will be only once as we call the "max()" function
    foreach ($rs as $rs_item) {
	    $row = $rs_item;
    }

    $query = "select * from gentle_saldo_update where id = '".$row->id."'";
    $rs = db_query($query);

    # iterate over saldo_updates item, will be only once as the updateid is a unique primary key
    foreach ($rs as $rs_item) {
	    $row = $rs_item;
    }

    $update_id = $row->id;

    if (!$update_id) {
        $html = t("Er zijn nog geen saldo's beschikbaar");
    } else {
        $html = "";
        $html .= "<h2>" . t("Financieel overzicht: update van ") . date("d-m-Y", $row->date) . "</h2>"; 
        $html .= "<p>" . t("Opmerking: ") . $row->remarks . "</p>";

        $html .= "<table><thead><tr>";
	    $html .= "<th align='center'>" . t("Datum") . "</th>";
	    $html .= "<th align='right'>" . t("Cumul") . "</th>";
	    $html .= "<th align='right'>" . t("Bedrag") . "</th>";
	    $html .= "<th align='left'>" . t("Beschrijving") . "</th>";
	    $html .= "<th align='left'>" . t("Opmerkingen") . "</th>";
	    $html .= "</tr></thead><tbody>";

        $rs = db_query("SELECT * FROM {gentle_saldo_transaction} WHERE gentle_saldo_update_id = :update_id and uid = :uid order by date, id", array(
            ':update_id' => $update_id,
            ':uid' => $uid,
        ));
        
	    $cumul = 0;
        $index = 0;
        $rowclass = 'even';
    
        foreach ($rs as $row) {
            if ($index % 2 == 0) {
                $rowclass = 'even';
            } else {
                $rowclass = 'odd';
            }

		    $html .= "<tr class='" . $rowclass ."'>";
		    $html .= "<td align='center'>" .date("d-m-Y", $row->date) . "</td>";
		    $html .= "<td align='right'>" . $cumul . "</td>";			
		    $html .= "<td align='right'>" . $row->amount . "</td>";
		    $html .= "<td align='left'>" . $row->description . "</td>";
		    $html .= "<td align='left'>" . $row->remarks . "</td>";
		    $html .= "</tr>";

		    $cumul += $row->amount;

            $index++;
	    }
	
	    $html .= "</tbody></table><br /><br />";
	    $html .= "<strong>" . t("HUIDIG SALDO: ") . $cumul . "</strong>";   
    }

    $html .= "<br /><br />";

    $html .= nl2br(variable_get('gentle_saldo_bank_details', ''));

    return $html;
}

/**
 * The form with settings for the Gentle saldo system.
 */
function gentle_saldo_settings() {
    $form = array();
    $form['gentle_saldo_email'] = array(
        '#type' => 'textfield',
        '#title' => t('Email sender'),
        '#default_value' => variable_get('gentle_saldo_email', variable_get('site_mail', '')),
        '#size' => 128,
        '#maxlength' => 128,
        '#description' => t("The sender of the email members will receive with their saldo update."),
        '#required' => TRUE,
    );

    $form['gentle_saldo_email_subject'] = array(
        '#type' => 'textfield',
        '#title' => t('Email subject'),
        '#default_value' => variable_get('gentle_saldo_email_subject', 'Gentle Saldo Update'),
        '#size' => 128,
        '#maxlength' => 128,
        '#description' => t("The subject of the email members will receive with their saldo update."),
        '#required' => TRUE,
    );

    $form['gentle_saldo_email_body_plain'] = array(
        '#type' => 'textarea',
        '#title' => t('Email body (non-HTML)'),
        '#default_value' => variable_get('gentle_saldo_email_body_plain', ''),
        '#maxlength' => 4096,
        '#description' => t("The body of the email members will receive with their saldo update, if their mail client doesn't support HTML."),
        '#required' => FALSE,
    );
    
    $form['gentle_saldo_email_body_html'] = array(
        '#type' => 'textarea',
        '#title' => t('Email body (HTML)'),
        '#default_value' => variable_get('gentle_saldo_email_body_html', ''),
        '#maxlength' => 4096,
        '#description' => t("The body of the email members will receive with their saldo update, if their mail client supports HTML."),
        '#required' => FALSE,
    );

    $form['gentle_saldo_bank_details'] = array(
        '#type' => 'textarea',
        '#title' => t('Bankgegevens'),
        '#default_value' => variable_get('gentle_saldo_bank_details', ''),
        '#maxlength' => 600,
        '#description' => t("The bank details so members know how and where to transfer the correct amount. HTML is allowed."),
        '#required' => TRUE,
    );

    return system_settings_form($form);
}

/**
 * Implementation of hook_admin_validate
 */
function gentle_saldo_settings_validate($form, &$form_state) {
    $email = $form_state['values']['gentle_saldo_email'];
    if (!valid_email_address($email)) {
        form_set_error('gentle_saldo_email', t('You must enter a valid email address.'));
    }
}

/**
 * The page for managing the Gentle saldos
 */
function gentle_saldo_update() {
    return drupal_get_form('gentle_saldo_update_form');
}

function gentle_saldo_update_form() {
    $form = array();
    $form['gentle_saldo_update_file'] = array(
        '#type' => 'file', 
        '#title' => t('Saldo file'),
        '#description' => t('Upload the saldo text file here.'),
    );

    $form['submit_button'] = array(
        '#type' => 'submit',
        '#value' => t('Submit'),
    );

    return $form;
}

/**
 * Validates the form for updating the saldos
 */
function gentle_saldo_update_form_validate($form, &$form_state) {
    // TODO: check if there is a file
}

/**
 * Code executed after submitting the form for updating the saldos
 */
function gentle_saldo_update_form_submit($form, &$form_state) {
    $directory = "public://gentle_saldo";
    $result = file_prepare_directory($directory, FILE_MODIFY_PERMISSIONS | FILE_CREATE_DIRECTORY);
    
    if($result) {
        $save = file_save_upload('gentle_saldo_update_file', array(), $directory, true);
        
        if(!$save) {
            drupal_set_message(t('Error uploading file to !dir.', array('!dir' => $directory)), 'error');
        } else {
            drupal_set_message(t('The file (!filename) was successfully uploaded.', array('!filename' => $save->filename)), 'status');
            gentle_saldo_update_saldos($save->uri);
        }

        //variable_set('date_pic_font', $dir . '/' . $file);
    } else {
        drupal_set_message(t('The directory !dir is not accessible. Please contact the site administrator.', array('!dir' => $directory)), 'error');
    }
}

/**
 * The overview page for the saldos.
 */
function gentle_saldo_overview() {
    return drupal_get_form('gentle_saldo_overview_form');
}

/**
 * Returns the form with the overview of the saldos and for sending the mail.
 */
function gentle_saldo_overview_form() {
    $form = array();

    // TODO: simplify code for getting max(id), also in user page code
    $row = "";	
    $query = "select max(id) as id from gentle_saldo_update";
    $rs = db_query($query);

    # iterate over resultset, will be only once as we call the "max()" function
    foreach ($rs as $rs_item) {
	    $row = $rs_item;
    }

    $query = "select * from gentle_saldo_update where id = '".$row->id."'";
    $rs = db_query($query);

    # iterate over saldo_updates item, will be only once as the updateid is a unique primary key
    foreach ($rs as $rs_item) {
	    $row = $rs_item;
    }

    $update_id = $row->id;

    $rs = db_query("SELECT g.uid, u.name, SUM(g.amount) as 'total' 
                    FROM {gentle_saldo_transaction} g
                        INNER JOIN {users} u ON u.uid = g.uid
                    WHERE g.gentle_saldo_update_id = :update_id 
                    GROUP BY g.uid, u.name", array(
            ':update_id' => $update_id,
        ));

    $html ='<table><thead><tr><th>' . t('Username') . '</th><th>' . t('Saldo') . '</th></tr></thead>';
    $html .= '<tbody>';
    # iterate over saldo_updates item, will be only once as the updateid is a unique primary key
    $index = 0;
    $rowclass = 'even';
    foreach ($rs as $rs_item) {
        if ($index % 2 == 0) {
            $rowclass = 'even';
        } else {
            $rowclass = 'odd';
        }

	    $row = $rs_item;
        $html .= '<tr class="' . $rowclass . '"><td>' . $row->name . '</td><td>' . round($row->total, 2) . '</td></tr>';
        $index++;
    }

    $html .= '</tbody></table>';

    if (user_access('debug gentle_saldo')) {
        $form['gentle_saldo_debug'] = array(
            '#type' => 'checkbox',
            '#title' => t('Debug-mode'),
            '#description' => t('Sends emails to a single address for testing purposes'),
        );

        $form['gentle_saldo_debug_to'] = array(
            '#type' => 'textfield',
            '#title' => t('Send debug mails to'),
            '#description' => t('Sends a maximum of 4 debug mails to this address.'),
        );

        $form['gentle_saldo_debug_smtp'] = array(
            '#type' => 'textfield',
            '#title' => t('SMTP server for debugging'),
            '#description' => t('The SMTP server to use for debugging. This must be a server that doesn\'t require authentication.
                                 You can use aspmx.l.google.com (with port 25) without authentication if you are sending to a GMail address.'),
        );

        $form['gentle_saldo_debug_port'] = array(
            '#type' => 'textfield',
            '#title' => t('Port for SMTP server for debugging'),
        );
    }

    $form['gentle_saldo_overview_markup'] = array(
        '#markup' => $html, 
    );

    $form['gentle_saldo_send_only_to_negative_saldos'] = array(
        '#type' => 'checkbox',
        '#title' => t('Send mails only to users with a negative saldo'),
    );

    $form['submit_button'] = array(
        '#type' => 'submit',
        '#value' => t('Send mails'),
    );

    return $form;
}

/**
 * Code executed after submitting the overview form.
 */
function gentle_saldo_overview_form_submit($form, &$form_state) {
    $sendOnlyToNegativeSaldos = $form_state['values']['gentle_saldo_send_only_to_negative_saldos'];

    // TODO: simplify code for getting max(id), also in user page code
    $row = "";	
    $query = "select max(id) as id from gentle_saldo_update";
    $rs = db_query($query);

    # iterate over resultset, will be only once as we call the "max()" function
    foreach ($rs as $rs_item) {
	    $row = $rs_item;
    }

    $query = "select * from gentle_saldo_update where id = '".$row->id."'";
    $rs = db_query($query);

    # iterate over saldo_updates item, will be only once as the updateid is a unique primary key
    foreach ($rs as $rs_item) {
	    $row = $rs_item;
    }

    $update_id = $row->id;

    // TODO: this means only one query, but we're re-using the function for the HTML which does a query per user
    $rs = db_query("SELECT g.uid, u.mail, SUM(g.amount) as 'saldo'
                    FROM {gentle_saldo_transaction} g
                        INNER JOIN {users} u ON u.uid = g.uid
                    WHERE g.gentle_saldo_update_id = :update_id
                    GROUP BY g.uid, u.mail", array(
            ':update_id' => $update_id,
        ));

    $successNumber = 0;
    $errorNumber = 0;
    
    foreach($rs as $row) {
        if ($form_state['values']['gentle_saldo_debug'] && $successNumber > 4) {
            break;
        }

        if ($sendOnlyToNegativeSaldos && $row->saldo > 0) {
            continue;
        }

        $params['uid'] = $row->uid;
            
        $to = $row->mail;
        if ($form_state['values']['gentle_saldo_debug']) {
            if ($form_state['values']['gentle_saldo_debug_smtp'] != '') {
                ini_set('SMTP', $form_state['values']['gentle_saldo_debug_smtp']);
                ini_set('smtp_port', $form_state['values']['gentle_saldo_debug_port']);
            }
            
            $to = $form_state['values']['gentle_saldo_debug_to'];
        }

        $message = drupal_mail('gentle_saldo', 'update', $to, NULL, $params, variable_get('gentle_saldo_email'), TRUE);
        // TODO: counter of successful/unsuccessful emails
        $successNumber++;
    }

    if ($form_state['values']['gentle_saldo_debug']) {
        drupal_set_message(t('Sent out !successNumber debugging mails successfully, !errorNumber were unsuccessful. 
                              No actual members received an email, because you selected debug-mode.', 
                            array('!successNumber' => $successNumber,
                                  '!errorNumber' => $errorNumber)), 'status');
    } else {
        drupal_set_message(t('Sent out !successNumber mails successfully, !errorNumber were unsuccessful.', 
                            array('!successNumber' => $successNumber,
                                  '!errorNumber' => $errorNumber)), 'status');
    }
}

/**
 * The saldo mail for users.
 */
function gentle_saldo_mail($key, &$message, $params) {
    $message['subject'] = variable_get('gentle_saldo_email_subject');
    $message['body'][] = variable_get('gentle_saldo_email_body_html');
    $message['body'][] = gentle_saldo_user_saldo_html($params['uid']);
}

/**
 * Converts a datestring to a timestamp
 */
function gentle_saldo_datestring_to_timestamp($datestring) {
	$tokens = explode(gentle_saldo_delimiter_lookup($datestring), $datestring);
	$timestamp = mktime(0,0,0,$tokens[1],$tokens[0],$tokens[2]);
	return $timestamp;
}

/**
 * Looks up the delimiter
 */
function gentle_saldo_delimiter_lookup($datestring) {
	return ((count(explode("-", $datestring)) > 1) ? '-' : '/');
}

/**
 * Updates all saldos
 */
function gentle_saldo_update_saldos($saldoFileUri) {
    $fp_saldo = fopen($saldoFileUri, 'r');
    $buffer = 4096;
    $total_line_counter = 0;
    $empty_line_counter = 0;
    $cntr = 0;
    $header_processed = false;
    $header = "";
    $date_update = NULL;
    $id_update = "";
    
    $id_speler = "";
    $naam_speler = "";
    $speler_processed = true;

    try {
        while(($line = fgets($fp_saldo, $buffer)) ){
	        $total_line_counter++;
	        $line_stripped = preg_replace("/\t/", "", $line); //alle tabs uit lijn weghalen (voor check op lege lijnen)
	        if ($line_stripped != "\n" && $line_stripped != "\r\n"){ // als lijn niet leeg is, lijn processen
		        $tokens = explode("\t", $line);
		        if($header_processed == false){ // header processen en opslaan in db
			        if (preg_match("/\tlaatste update:\t/", $line)){
				        $date_update = gentle_saldo_datestring_to_timestamp($tokens[2]);
			        }
			        elseif (preg_match("/.*naam\tdatum\tcumulatief\tbedrag\tthema\tverwijzing\/opmerking.*/", $line)){
				        $header_processed = true; //header is volledig ingelezen, header schrijven naar db
                        $id_update = db_insert('gentle_saldo_update')
                            ->fields(array(
                                'date' => $date_update,
                                'remarks' => $header,
                            ))
                            ->execute();
			        }
			        else {
				        if (!preg_match("/^spelers saldos$/", trim($line_stripped))){
					        $header.= htmlspecialchars(trim($line, " \t"),ENT_QUOTES, "cp1252");
				        }
			        }
		        }
		        else { //header is geprocessed, nu transacties inlezen en schrijven naar db
                    if (trim($tokens[2]) == "totaal"){
				        $speler_processed = true;
			        }
			        else {
				        if ($speler_processed == true){
					        $id_speler = htmlspecialchars(trim($tokens[0]), ENT_QUOTES, "cp1252");
					        $naam_speler = htmlspecialchars(trim($tokens[1]), ENT_QUOTES, "cp1252");
					        $speler_processed = false;
				        }

				        $datum = gentle_saldo_datestring_to_timestamp($tokens[2]);
				        $bedrag = htmlspecialchars(trim(str_replace(",",".",$tokens[4])), ENT_QUOTES, "cp1252");
				        $beschrijving = htmlspecialchars(trim($tokens[5]), ENT_QUOTES, "cp1252");
				        $opmerking = htmlspecialchars(trim($tokens[6]), ENT_QUOTES, "cp1252");

                        if ($id_speler == '') {
                            continue; // TODO: counter on how many were empty?
                        }

                        if (!user_load($id_speler)) {
                            continue; // TODO: counter on how many were skipped?
                        }

                        db_insert('gentle_saldo_transaction')
                            ->fields(array(
                                'uid' => $id_speler,
                                'gentle_saldo_update_id' => $id_update,
                                'date' => $datum,
                                'amount' => $bedrag,
                                'description' => $beschrijving,
                                'remarks' => $opmerking,
                            ))
                            ->execute();
				        $cntr++;			
			        }
		        }
	        }
	        else $empty_line_counter++;
        }
    
        fclose($fp_saldo);
        drupal_set_message(t('Added !counter records from !total_rows (!empty_rows empty rows).', 
            array('!counter' => $cntr, '!total_rows' => $total_line_counter, '!empty_rows' => $empty_line_counter)), 'status');   
    } catch (Exception $e) {
        drupal_set_message($e->getMessage(), 'error');
    }
}