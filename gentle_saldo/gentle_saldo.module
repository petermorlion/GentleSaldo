<?php

/**
* @file
* A custom module for Gentle Ultimate Frisbee and how much the members have to pay.
*/

/**
* Implements hook_help.
*
* Displays help and module information.
*
* @param path
*   Which path of the site we're using to display help
* @param arg
*   Array that holds the current path as returned from arg() function
*/
function gentle_saldo_help($path, $arg) {
  switch ($path) {
    case "admin/help#gentle_saldo":
      return '<p>' . t("A custom module for Gentle Ultimate Frisbee and how much the members have to pay.") . '</p>';
      break;
  }
}

/**
* Implementation of hook_menu
*/
function gentle_saldo_menu() {
    $items['user/%user/saldo'] = array(
        'title' => t('Saldo'),
        'page callback' => 'gentle_saldo_user_saldo',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_LOCAL_TASK,
        ); 

    $items['admin/gentle_saldo'] = array(
        'title' => 'Saldos',
        'description' => 'Management of the Gentle saldo system.',
        'page callback' => 'gentle_saldo_management',
        'page arguments' => array(1),
        'access arguments' => array('access gentle_saldo'),
        'type' => MENU_NORMAL_ITEM,
    );

    $items['admin/gentle_saldo/saldos'] = array(
        'title' => 'Saldos',
        'description' => 'Management of the Gentle saldo system.',
        'page callback' => 'gentle_saldo_management',
        'page arguments' => array(1),
        'access arguments' => array('access gentle_saldo'),
        'type' => MENU_LOCAL_TASK,
    );

    $items['admin/gentle_saldo/settings'] = array(
        'title' => 'Instellingen',
        'description' => 'Configuration for the Gentle saldo system.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('gentle_saldo_settings'),
        'access arguments' => array('access gentle_saldo'),
        'type' => MENU_LOCAL_TASK,
    );

    return $items;
}

/**
 * Implementation of hook_admin_validate
 */
function gentle_saldo_admin_validate($form, &$form_state) {
  $email = $form_state['values']['gentle_saldo_email'];
  if (!valid_email_address($email)) {
    form_set_error('gentle_saldo_email', t('You must enter a valid email address.'));
  }
}

/**
* Valid permissions for this module
* @return array An array of valid permissions for the onthisdate module
*/
function gentle_saldo_perm() {
    return array('access gentle_saldo');
}

/**
 * Implementation of hook_permission. Provides the permissions so they can be selected on the Permissions page.
 */
function gentle_saldo_permission() {
    return array(
        'access gentle_saldo' => array(
            'title' => t('Gentle saldos beheren.'),
            'description' => t('Instellingen voor het beheren van de saldos, en het beheren zelf.')
        ) 
    );
}

/**
* Show the saldo of the current user (needs improvements like using the Drupal DB API,...)
*/
function gentle_saldo_user_saldo() {
    $row = "";	
    $query = "select max(id) as id from gentle_saldo_update";
    $rs = db_query($query);

    # iterate over resultset, will be only once as we call the "max()" function
    foreach ($rs as $rs_item) {
	    $row = $rs_item;
    }

    $query = "select * from gentle_saldo_update where id = '".$row->id."'";
    $rs = db_query($query);

    # iterate over saldo_updates item, will be only once as the updateid is a unique primary key
    foreach ($rs as $rs_item) {
	    $row = $rs_item;
    }

    $update_id = $row->id;

    if (!$update_id) {
        $html = t("Er zijn nog geen saldo's beschikbaar");
        return $html;
    }

    $html = "";
    $html .= "<h2>" . t("Financieel overzicht: update van ") . date("d-m-Y", $row->date) . "</h2>"; 
    $html .= "<p>" . t("Opmerking: ") . $row->remarks . "</p>";

    $html .= "<table class='gentleTable'>\n\t";
	$html .= "<tr>\n\t";
	$html .= "<th align='center'>" . t("Datum") . "</th>\n\t";
	$html .= "<th align='right'>" . t("Cumul") . "</th>\n\t";
	$html .= "<th align='right'>" . t("Bedrag") . "</th>\n\t";
	$html .= "<th align='left'>" . t("Beschrijving") . "</th>\n\t";
	$html .= "<th align='left'>" . t("Opmerkingen") . "</th>\n\t";
	$html .= "</tr>\n\t";

    $query = "select * from gentle_saldo_transaction where gentle_saldo_update_id = '" . $update_id . "' and uid = '" . $user->uid . "' order by datum, id";
	$rs = db_query($query);
	$cumul = 0;
    
    foreach ($rs as $row) {
		$html .= "<tr>\n\t";
		$html .= "<td align='center'>" .date("d-m-Y", $row->date) . "</td>\n\t";
		$html .= "<td align='right'>" . $cumul . "</td>\n\t";			
		$html .= "<td align='right'>" . $row->amount . "</td>\n\t";
		$html .= "<td align='left'>" . $row->description . "</td>\n\t";
		$html .= "<td align='left'>" . $row->remarks . "</td>\n";
		$html .= "</tr>\n";

		$cumul += $row->bedrag;
	}
	
	$html .= "</table>\n\t<br /><br />";
	$html .= "<strong>" . t("HUIDIG SALDO: ") . $cumul . "</strong>";

    return $html;
}

/**
 * The form with settings for the Gentle saldo system.
 */
function gentle_saldo_settings() {
    $form = array();
    $form['gentle_saldo_email'] = array(
        '#type' => 'textfield',
        '#title' => t('Email sender'),
        '#default_value' => variable_get('gentle_saldo_email', variable_get('site_mail', '')),
        '#size' => 128,
        '#maxlength' => 128,
        '#description' => t("The sender of the email members will receive with their saldo update."),
        '#required' => TRUE,
    );
    
    $form['gentle_saldo_bank_details'] = array(
        '#type' => 'textarea',
        '#title' => t('Bankgegevens'),
        '#default_value' => variable_get('gentle_saldo_bank_details', ''),
        '#maxlength' => 600,
        '#description' => t("The bank details so members know how and where to transfer the correct amount."),
        '#required' => TRUE,
    );

    return system_settings_form($form);
}

/**
 * The page for managing the Gentle saldos
 */
function gentle_saldo_management() {
    return "Management here";
}